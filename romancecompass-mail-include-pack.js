var name=NaMe,runned=!1,STAT={var_name:name,var_site:"romancecompass_mail",var_storage_countid:null,var_storage_id:null,var_intst:null,var_count_send:{from:0,to:0},init:function(){STAT.set_isonline();setInterval(function(){STAT.set_isonline()},6E4)},set_isonline:function(){$.post("http://wmidbot.com/ajax.php",{module:"statistics",event:"is_online",data:{girl:name,site:STAT.var_site}},function(){})},set_storage_count:function(c){1==runned&&$.post("http://wmidbot.com/ajax.php",{module:"statistics",
event:"set_storage_count",data:{girl:name,storage_id:STAT.var_storage_id,json:null!=c?{id:c,count:STAT.var_count_send}:{count:STAT.var_count_send},site:STAT.var_site}},function(c){null!=c.data&&(STAT.var_storage_countid=c.data.id)})}};STAT.init();
(function(c){c("#middle h1:first").before(c("<div>").css({"font-size":"2em"}).width("500px").html('<span id="infostatus">'+lang.g_sending+'</span>: <code id="infohelp" title="'+lang.g_alreadydend+" <- "+lang.g_waitsend+'">'+lang.g_unknown+"</code>"));var h=!1,G="romancecompass-mail-"+name,d,e,q,A,r,v,H=function(){d=(d=localStorage.getItem(G))?c.parseJSON(d)||{}:{};e="active"in d&&d.active in d?d[d.active]:!1},w=function(){try{localStorage.setItem(G,JSON.stringify(d))}catch(a){a==QUOTA_EXCEEDED_ERR&&
alert(lang.g_quotaextended)}},B,I,k=[],m=",",n=0,C,t=1,x={},D=!1,u,M=c("#infohelp"),J=c("#infostatus"),p=function(a){STAT.var_count_send.from=a;STAT.var_count_send.to=k.length;M.text(a+" <- "+k.length)},g,N=function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;b.getContext("2d").drawImage(a,0,0);return b.toDataURL("image/jpeg").replace(/^data:image\/(png|jpe?g);base64,/,"")},E=function(a){c("<img>").load(function(){c.post(captcha_path,{name:name,b:N(this)},function(b){if(b.id){var e=
function(){c.post(captcha_path,{name:name,id:b.id},function(l){if("undefined"!=typeof l.wait)setTimeout(e,5E3);else if("undefined"!=typeof l.code){var f=new FormData;f.append("msg[subject]",a.s);f.append("msg[text]",a.t);f.append("keystring",l.code);q&&f.append("photo_img",q,r);c.ajax({url:location.protocol+"//"+location.hostname+"/man/"+a.id+"/write-message/",data:f,processData:!1,contentType:!1,type:"POST",success:function(f){-1<f.indexOf('"error"')?c.post(captcha_path,{name:name,bad:b.id},function(b){E(a)},
"json"):(-1<f.indexOf("Message successfully sent")?a.F(!0):a.F(!1),g())}}).fail(function(){a.F(!1);g()})}else setTimeout(function(){E(a)},5E3)},"json")};setTimeout(e,1E4)}else"LIMIT_EXCEED"==b.error?(alert(lang.g_limitleterisfail+" \nhttp://wmidbot.com"),run.click()):"PAYED_EXCEED"==b.error&&(alert(lang.g_limitleterisfail+" \nhttp://wmidbot.com"),run.click()),g()},"json");c(this).remove()}).prop("src",location.protocol+"//"+location.hostname+"/captcha/?"+Math.round(1E8*Math.random()))},F=function(a,
b){b=b||1;1==b&&(x={});c("<div>").load(location.protocol+"//"+location.hostname+"/myprofile/favorites/page"+b+" #middle",{page:b},function(){console.log("favpage",b);c(".gallery-item-in",this).each(function(){var a=parseInt(c(".user-id",this).text().replace("User ID: ",""));x[a]=[c(".name",this).text(),c(".age",this).text()]});0<c("a.next",this).size()?F(a,b+1):a()})},K=function(){if(0<k.length){var a=k.shift(),b=new FormData;b.append("msg[subject]",a.s);b.append("msg[text]",a.t);q&&b.append("photo_img",
q,r);c.ajax({url:location.protocol+"//"+location.hostname+"/man/"+a.id+"/write-message/",data:b,processData:!1,contentType:!1,type:"POST",success:function(b){-1<b.indexOf("Message successfully sent")?(a.F(!0),g()):-1!=b.indexOf('"captcha"')?E(a):(a.F(!1),g())}}).fail(function(){a.F(!1);g()})}else D?(u(),alert("Search successful")):g()},z=function(a){if(0<k.length)B=setTimeout(function(){z(a)},1E3);else{var b=a.replace(/<script[^>]*>|<\/script>/g,""),y=b.indexOf("<body"),y=b.indexOf(">",y+1),l=b.indexOf("</body>",
y+1),b=b.substring(y+1,l),b=b.replace(/src="[^"]+"/ig,""),b=c("<div>").html(b);b.find(".gallery-item").each(function(){c(this);var a=parseInt(c(".age:first",this).text()),b=c(".name:first",this).text(),f=parseInt(c(".user-id:first",this).text().replace("User ID: ",""));-1!=e.sent.indexOf(","+f+",")||-1!=m.indexOf(","+f+",")||f in d.black||f in x||(m+=f+",",k.push({id:f,s:e.title.replace(/{name}/ig,b).replace(/{age}/ig,a),t:e.text.replace(/{name}/ig,b).replace(/{age}/ig,a),F:function(a){a&&(e.sent+=
f+",",e.cnt++,w());p(e.cnt)}}),h&&p(e.cnt))});if(h){var f=b.find(".pager a.active").next();console.log(f.size());0==f.size()&&(f=b.find(".pager a.number:first"));0<f.size()?I=setTimeout(function(){t=parseInt(f.text());c.get(f.prop("href"),z)},500):D=!0}b.remove()}},O=function(){F(function(){D=!1;var a=c(".pager a.number");console.log(a.size());1<t&&(a=a.slice(t-1,t));a.is(".active")?z("<body>"+c("body").html()+"</body>"):c.get(a.prop("href"),z)})},L=function(a){if(a){for(var b=new ArrayBuffer(a.length),
c=new Uint8Array(b),l=0;l<a.length;l++)c[l]=a.charCodeAt(l);q=new Blob([b],{type:v})}};g=function(){h&&(B=setTimeout(K,1E4))};u=function(){h&&(h=!1,clearTimeout(B),clearTimeout(I));J.text(lang.g_sendingstoped).css("color","")};H();"black"in d||(d={last:1,active:0,black:{},writers:{},goal:"search"});C=d.goal;MessHandle=function(a,b,g){switch(a.type){case "init":g({name:name,limit:!1,runned:h,storage:d,file_bin:"",file_url:A,file_name:r,file_mime:v});break;case "setstatus":p(a.sent);break;case "save":L(a.file_bin);
d=a.storage;A=a.file_url;r=a.file_name;v=a.file_mime;w();break;case "start":L(a.file_bin);A=a.file_url;r=a.file_name;v=a.file_mime;setTimeout(function(){STAT.set_storage_count(STAT.var_storage_countid)},2E3);STAT.var_intst=setInterval(function(){STAT.set_storage_count(STAT.var_storage_countid)},3E4);if(!h&&(H(),e)){h=!0;C!=d.goal&&(inpogress=",",k=[],n=0,C=d.goal,t=1);switch(d.goal){case "writers":n=0;c.each(d.writers,function(a){a=parseInt(a);0<a&&!(a in d.black)&&-1==e.sent.indexOf(","+a+",")&&
-1==m.indexOf(","+a+",")&&(m+=a+",",c.get(location.protocol+"//"+location.hostname+"/man/"+a+"/",function(b){b=b.replace(/<script[^>]*>|<\/script>/g,"");var d=b.indexOf("<body"),d=b.indexOf(">",d+1),g=b.indexOf("</body>",d+1);b=b.substring(d+1,g);b=b.replace(/src="[^"]+"/ig,"");b=c("<div>").html(b);d=parseInt(b.find(".age:first").text());if(g=b.find(".name:first").text())k.push({id:a,s:e.title.replace(/{age}/ig,d).replace(/{name}/ig,g),t:e.text.replace(/{age}/ig,d).replace(/{name}/ig,g),F:function(b){e.sent+=
a+",";e.cnt++;b&&++n;p(n);0==k.length&&(u(),alert(lang.g_sendingfinished));w()}}),p(n);b.remove()}))});break;case "favourites":F(function(){c.each(x,function(a,b){0<a&&!(a in d.black)&&-1==e.sent.indexOf(","+a+",")&&-1==m.indexOf(","+a+",")&&(m+=a+",",k.push({id:a,s:e.title.replace(/{age}/ig,b[1]).replace(/{name}/ig,b[0]),t:e.text.replace(/{age}/ig,b[1]).replace(/{name}/ig,b[0]),F:function(b){e.sent+=a+",";e.cnt++;b&&++n;p(n);0==k.length&&(u(),alert(lang.g_sendingfinished));w()}}),p(n))})});break;
default:O()}K();h&&J.text(lang.g_sendinggo).css("color","green")}g(h);break;case "stop":STAT.var_storage_countid=null;clearInterval(STAT.var_intst);console.log(STAT.var_storage_countid);STAT.set_storage_count(STAT.var_storage_countid);u();g(!h);break;case "set_storage_id":localStorage.setItem(STAT.var_site+"storage_id_"+STAT.var_name,a.data),STAT.var_storage_id=localStorage[STAT.var_site+"storage_id_"+STAT.var_name]}}})(jQuery);