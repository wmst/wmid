<div class="clear10"></div>
<div class="message"></div>
<div class="clear10"></div>
<div class="home">
    <div class="header">
       <h1 class="logo"><a href="http://wmidbot.com" lng="g_logo">WMID.com.ua Bot программы для брачных агенств для золушки, дрима, свадьбы, джампа</a></h1>
        <div class="online"><div class="fl"><b class="tx_online" id="tx_online">0</b> Online Men</div> <a href="#" class="up_online" id="up_online">&nbsp;</a></div>
         <div class="online"><div class="fl"><b class="tx_platil" id="tx_online_ac">0</b> <span lng="s_actualonline">Актуальный Online</span></div></div>
        <div class="online"><div class="fl"><b class="tx_platil" id="tx_platil">0</b> <span lng="s_platilmanonline">Платящих мужчин</span></div></div>
        <div class="clear10"></div>
    </div>
    <div class="content">
        <div class="leftColumn">
            <ul class="navi">
                <li><a href="http://wmidbot.com/pages/#conte" target="_blank" lng="g_help">Справка</a></li>
				<li><a href="http://wmidbot.com/" target="_blank" lng="g_bayact">Продлить активацию</a></li>
                <li><a href="#" id="blecklist_link" lng="g_balcklist">Черный список</a></li>
                <li><a href="#" id="pisal_link" lng="g_pisallist">Фавориты</a></li>
                <li><a href="#" id="clean_cookie" lng="g_cleancookie">Очистить куки</a></li>
            </ul>
            <div class="clear10"></div>
            <div class="clear10"></div>
            <div class="clear10"></div>
            <div class="active">
				<span lng="g_pay_to">Оплачено до:</span><br /><b id="payed"></b>
			</div>
            <div class="clear10"></div>
            <div class="baner"></div>
        </div>
        <div class="rightColumn blecklist">
        	<a href="#" class="back"><b lng="s_back">&laquo;Назад</b></a><div class="clear5"></div>
        	<b class="title" lng="g_balcklist">Черный список</b><div class="clear5"></div>
            <select class="bleck_list" id="blecklist" multiple>
            	<option lng="g_pusto">- Пусто -</option>
            </select>
            <div class="clear5"></div>
            <span style="font-size:11px;" lng="s_delselectmoreman">* перед удалением выберите одного или несколько мужчин в списке</span> 
            <div class="clear10"></div>
            <a href="#" id="add_bleck" class="Btn_normal"><b lng="g_add">Добавить</b></a>
            <a href="#" id="rem_bleck" class="Btn_red_normal"><b lng="g_delete">Удалить</b></a>
        </div>
        <div class="rightColumn pisal">
        	<a href="#" class="back"><b lng="s_back">&laquo;Назад</b></a><div class="clear5"></div>
        	<b class="title" lng="g_pisallist">Cписок писателей</b><div class="clear5"></div>
            <select class="pisal_list" id="pisal" multiple>
            	<option>- Пусто -</option>
            </select>
            <div class="clear5"></div>
            <span style="font-size:11px;" lng="s_delselectmoreman">* перед удалением выберите одного или несколько мужчин в списке</span> 
            <div class="clear10"></div>
            <a href="#" id="add_pisal" class="Btn_normal"><b lng="g_add">Добавить</b></a>
            <a href="#" id="rem_pisal" class="Btn_red_normal"><b lng="g_delete">Удалить</b></a>
        </div>
        <div class="rightColumn general">
            <textarea class="text_ms" id="text_ms" get-popover="true" text-popover="{name} - Name<br>{age} - Age">Hi {name}!</textarea>
            <div class="clear10"></div>
            <table width="100%" class="table_1">
                <tr>
                    <td>
                        <b class="title" lng="g_sendfor">Отсылать по</b>
                        <div class="clear5"></div>
                        <select class="sel_100" id="typeSend">
                            <option>Online</option>
                            <option>Contact</option>
                            <option lng="g_for_favorites">Фаворитам</option>
                            <option class="red" lng="g_for_platil">Платящим</option>
                            <option lng="s_actualonline">Актуальный Online</option>
                            <option class="red" lng="s_for_interest">Интересующиеся</option>
                        </select>
                    </td>
                    <td class="center">&nbsp;</td>
                    <td>
                        <b class="title" lng="s_speed">Скорость</b>
                        <div class="clear5"></div>
                        <select class="sel_100" id="speed">
                            <option lng="s_slow">Медленно</option>
                            <option selected lng="s_normal">Нормально</option>
                            <option lng="s_fast">Быстро</option>
                        </select>
                    </td>
                </tr>
            </table>
            <div class="clear10"></div>
            <div id="ages">
            <table width="71%" class="table_1">
                <tr>
                    <td>
                        <b class="title" lng="g_age_from">Возраст</b>
                        <div class="clear5"></div>
                        <input type="number" id="age_from" value="20" min="20" max="100">
                    </td>
                    <td class="center"><b>-</b></td>
                    <td>
                        <b class="title" lng="g_to">&nbsp;</b>
                        <div class="clear5"></div>
                        <input type="number" id="age_to" value="80" min="20" max="100">
                    </td>
                </tr>
            </table>
            <div class="clear10"></div>
            </div>
            <div id="countr">
            <b class="title" lng="g_tocountries">По странам</b>
            <div class="clear5"></div>
            <select class="sel_100" id="country"></select>
            <div class="clear10"></div>
            </div>
            <label><input type="checkbox" id="vip">VIP</label>
            <select id="and_or"><option>OR</option><option>AND</option></select>
            <label><input type="checkbox" id="fake">Photo</label>
            <div class="clear10"></div>
            <div class="clear10"></div>
            <a href="#" class="Btn_big" id="start_send" style="display:none;"><b lng="g_start_send">Начать рассылку</b></a>
            <a href="#" class="Btn_big_red" id="end_send" style="display:none;"><b lng="s_stop_send">Стоп</b></a>
            <a href="#" class="Btn_big_yellow" id="pause_send" style="display:none;"><b lng="s_pause_send">Пауза</b></a>
        </div>
        <div class="clear"></div>
    </div>
</div>

<div id="hidden_load" lng="g_wait">Подождите...</div>
<script>
var WLANG = {
	init_html:function(){
		$.each(lang,function(i,v){
			$('[lng="'+i+'"').text(v);
		});
	}
};
WLANG.init_html();

var STAT = {
	var_storage_id: function(){
		return localStorage['storage_id_'+EWMID.var_user];
	},
	var_storage_loc: function(){
		var ls;
		if(STAT.var_storage_id()){
			ls = JSON.parse(localStorage['storage_loc_'+EWMID.var_user]);
		}
		return (ls?ls:'');
	},
	init: function(){
		STAT.events();
		STAT.get_storage_srv();
	},
	events: function(){
		$('#payed').text(udata.date);
	},
	get_storage_srv: function(){
		if(STAT.var_storage_loc()){
			WMID.send('set_storage_id',STAT.var_storage_id());
			STAT.set_settings_controls();
		}else{
			$.post('http://wmidbot.com/ajax.php',{'module':'statistics','event':'get_storage_invites','data':{girl:EWMID.var_user,site:'svadba_chat'}},function(d){
				if(d.data!=null){
					localStorage.setItem('storage_id_'+d.data.girl_id, d.data.id);
					localStorage.setItem('storage_loc_'+d.data.girl_id, d.data.settings);
					STAT.set_settings_controls();
					WMID.send('set_storage_id',STAT.var_storage_id());
				}
			});
		}
	},
	set_storage_srv: function(obj){
		if(obj){
			$.post('http://wmidbot.com/ajax.php',{'module':'statistics','event':'set_storage_invites','data':{girl:EWMID.var_user,json:obj,site:'svadba_chat'}},function(d){
				if(d.data!=null){
					localStorage.setItem('storage_id_'+EWMID.var_user, d.data);
					localStorage.setItem('storage_loc_'+EWMID.var_user, JSON.stringify(obj));
					WMID.send('set_storage_id',STAT.var_storage_id());
				}
			});
		}
	},
	set_settings_controls: function(){
		var ls = STAT.var_storage_loc();
		if(ls){
			ls = ls[0];
			$('#text_ms').html(ls.message);
			EWMID.var_age_from = EWMID.var_important_age_from = ls.age_from;
			EWMID.var_age_to = EWMID.var_important_age_to = ls.age_to;
			EWMID.set_age();
			$('#typeSend option').removeAttr('selected');
			$('#typeSend option:eq('+ls.list+')').attr('selected','selected');
			if($.cookie('s_online')){ $('#hidden_load').hide();}
			
			if(ls.list==0){
				$('#fake,#vip').parent().show();
				$('#countr,#ages,#and_or').show();
			}else if(ls.list==1){
				$('#countr, #and_or').hide();
				$('#fake,#vip').parent().hide();
				$('#ages').show();
			}else if(ls.list==2){
				$('#fake,#vip').parent().hide();
				$('#countr,#ages,#and_or').hide();
			}else if(ls.list==3){
				$('#fake,#vip').parent().show();
				$('#countr,#ages,#and_or').show();
			}
			if(ls.fake==1){ $('#fake').attr('checked','checked');}
			if(ls.vip==1){ $('#vip').attr('checked','checked');}
			$('#speed option').removeAttr('selected');
			$('#speed option:eq('+ls.speed+')').attr('selected','selected');
			$('#and_or option').removeAttr('selected');
			$('#and_or option:eq('+ls.and_or_vp+')').attr('selected','selected');
			$('#country option[value="'+ls.country+'"]').attr('selected','selected');
		}
	}
}


var WMID = {
	send: function(command, object, callback){
		chrome.tabs.getSelected(null, function(tab) {
		  chrome.tabs.sendMessage(tab.id, {command: command, object:object}, callback);
		});
	}
}
var service;
var EWMID = {
	init: function(){
		WMID.send('get_user','',function(response){ 
			EWMID.var_user = response.user;
			EWMID.get_blecklist();
			EWMID.get_pisal();
			EWMID.get_contacts();
			EWMID.get_platil();
			EWMID.get_online(function(){
				$('#hidden_load').hide();
				EWMID.set_age();
				EWMID.set_country(); 
				EWMID.get_attentions();
			});
			EWMID.get_online_actual(function(){EWMID.set_age();EWMID.set_country(); });
			WMID.send('get_status','',function(r){ 
			console.log(r.status);
				if(r.status=='stop'||r.status=='pause'){
					$('#start_send').show(); $('#end_send, #pause_send').hide();
				}else if(r.status=='start'){
					$('#start_send').hide(); $('#end_send, #pause_send').show();
				}
			});
			EWMID.get_active();
			EWMID.build_popover();
			EWMID.get_event();
			/*STAT*/	if(server){ STAT.init();}
		});
	},
	get_event: function(){
		$('#clean_cookie').click(function(){
			var date = new Date();date.setTime(date.getTime() - (10));
			$.cookie('s_online','true', { expires: date, path: '/' });
			$.cookie('s_attentions','true', { expires: date, path: '/' });
			$.cookie('s_platil','true', { expires: date, path: '/' });
			$.cookie('s_online_actual','true', { expires: date, path: '/' });
			$.cookie('s_contacts','true', { expires: date, path: '/' });
			$.cookie('start_online_'+EWMID.var_user,'true', { expires: date, path: '/' });
		});
		$('#add_pisal').click(function(){
			var mans = prompt(lang.g_addidman);
			if(mans){
				WMID.send('set_pisal',mans);
				EWMID.get_pisal();
			}
		});
		$('#rem_pisal').click(function(){
			var mans = $('#pisal').val();
			if(mans.length>0){
				WMID.send('rem_pisal',JSON.stringify(mans));
				EWMID.get_pisal();
			}
		});
		$('#add_bleck').click(function(){ 
			var mans = prompt(lang.g_addidman);
			if(mans){
				WMID.send('add_blist',mans);
				EWMID.get_blecklist();
			}
		});
		$('#rem_bleck').click(function(){ 
			var mans = $('#blecklist').val();
			if(mans.length>0){
				WMID.send('rem_blist',JSON.stringify(mans));
				EWMID.get_blecklist();
			}
		});
		$('#up_online').click(function(){
			$('#hidden_load').show();
			var date = new Date();date.setTime(date.getTime() - (10));
			$.cookie('s_online','true', { expires: date, path: '/' });
			$(this).addClass('animate');
			EWMID.get_online(function(){$('#hidden_load').hide();EWMID.set_age();EWMID.set_country(); });
			$('#typeSend option:selected').removeAttr('selected');
			$('#typeSend option:eq(0)').attr('selected','selected');
		});
		$('#blecklist_link').click(function(){
			$('.rightColumn').hide();
			$('.rightColumn.blecklist').fadeIn();
		});
		$('#pisal_link').click(function(){
			$('.rightColumn').hide();
			$('.rightColumn.pisal').fadeIn();
		});
		$('.back').click(function(){
			$('.rightColumn').hide();
			$('.rightColumn.general').fadeIn();
		});
		$('#typeSend').change(function(){
			var index = $(this).find('option:selected').index();
			EWMID.var_important_age_from = EWMID.var_important_age_to = 0;
			if(index==0){
				EWMID.get_online(function(){EWMID.set_age();EWMID.set_country();});
				$('#fake,#vip').parent().show();
				$('#countr,#ages,#and_or').show();
			}else if(index==1){
				EWMID.get_contacts(function(){EWMID.set_age();EWMID.set_country();});
				$('#fake,#vip').parent().hide();
				$('#and_or').hide();
				$('#countr,#ages').show();
			}else if(index==2){
				$('#fake,#vip').parent().hide();
				$('#countr,#ages,#and_or').hide();
			}else if(index==3){
				EWMID.get_platil(function(){ EWMID.set_age();EWMID.set_country();});
				$('#fake,#vip').parent().show();
				$('#countr,#ages,#and_or').show();
			}else if(index==4){
				EWMID.get_online_actual(function(){EWMID.set_age();EWMID.set_country();});
				$('#fake,#vip').parent().show();
				$('#countr,#ages,#and_or').show();
			}else if(index==5){
				EWMID.get_attentions(function(){ EWMID.set_age();EWMID.set_country();});
				$('#fake').parent().hide();
				$('#and_or').hide();
				$('#countr,#ages').show();
			}
		});
		$('#start_send').click(function(){
			if($(this).attr('rel')!='noclick'){
				EWMID.start_send();
			}
		});
		$('#end_send').click(function(){
			EWMID.end_send();
		});
		$('#pause_send').click(function(){
			EWMID.pause_send();
		});
	},
	end_send: function(){
		$('#start_send').show();
		$('#end_send,#pause_send').hide();
		$('#start_send').attr('rel','noclick');
		setTimeout(function(){ $('#start_send').removeAttr('rel','noclick');},2000);
		WMID.send('end_send','',function(response){ 
			console.log(response);		
		});
	},
	pause_send:function(){
		$('#start_send').show();
		$('#end_send,#pause_send').hide();
		WMID.send('pause_send','',function(response){ 
			console.log(response);
		});
	},
	start_send:function(){ 
		EWMID.get_message(function(m){
			if(m!=''&&m!='Hi {name}!'){
			if(m.split('@').length==1){
			if(m.split('://').length==1&&m.split('.com').length==1&&m.split('.ua').length==1&&m.split('.net').length==1&&m.split('.ru').length==1){
				$('#start_send').hide();
				$('#end_send,#pause_send').show();
				var oblect_send = [];
				var typeSend = $('#typeSend option:selected').index();
				var speed = $('#speed option:selected').index();
				var age_from = $('#age_from').val();
				var age_to = $('#age_to').val();
				var country = $('#country option:selected').val();
				var and_or_vp = $('#and_or option:selected').index();
				oblect_send.push({message:m,age_from:age_from,age_to:age_to,country:country,list:typeSend,fake: $('#fake:checked').length,vip:$('#vip:checked').length,and_or_vp:and_or_vp,speed:speed});
/*STAT*/		STAT.set_storage_srv(oblect_send);
				WMID.send('start_send',oblect_send);
			}else{
				alert(lang.g_error_link);
			}
			}else{
				alert(lang.g_error_email);
			}
			}else{
				alert(lang.g_addtextmessage);
			}
		});
	},
	build_popover:function(){
		$('textarea[get-popover=true]').each(function(){
			$(this).after('<div class="popover" style="display:none; top:'+$(this).position().top+'px;left:'+($(this).position().left-180)+'px"><div class="arrow"></div>'+$(this).attr('text-popover')+'</div>');
			$(this).focus(function(){
				$(this).next('.popover').fadeIn();
			});
			$(this).blur(function(){
				$(this).next('.popover').fadeOut();
			});
		});
	},
	var_age_from: 100,
	var_age_to: 0,
	var_important_age_from: 0,
	var_important_age_to: 0,
	var_online: [],
	var_online_actual:[],
	var_platil: [],
	var_blecklist: [],
	var_contacts: [],
	var_attentions: [],
	var_user:0,
	get_attentions: function(callback){
		if(!$.cookie('s_attentions')&&server){
			$.post('http://wmidbot.com/ajax.php',{'module':'statistics','event':'get_attentions','data':{girl:EWMID.var_user,site:'svadba_chat'}},function(r){
				EWMID.set_attentions(r,callback);
			});
		}else{
			EWMID.set_attentions('',callback);
		}
	},
	get_pisal: function(){
		WMID.send('get_pisal','',EWMID.set_pisal);
	},
	get_message: function(call){
		var message = $('#text_ms').val();
		call(message);
	},
	get_blecklist: function(){ 
		WMID.send('get_blist','',EWMID.set_blecklist);
		
	},
	get_platil: function(callback){
		if(!$.cookie('s_platil')){
			$.post('http://wmidbot.com/ajax.php',{'module':'statistics','event':'get_platil','data':{site:'svadba_chat'}},function(r){
				EWMID.set_platil((r.data!=null?JSON.parse(r.data):''),callback);
			});
		}else{
			EWMID.set_platil('',callback);
		}
	},
	get_online_actual:function(callback){
		if(!$.cookie('s_online_actual')){
			$.getJSON(
				"http://www.svadba.com/chat/updates/onlines/everyone/?onlines=99999999999999999",
				function(r){
					var no = [];
					$.each(r[0].updates,function(i,v){
						no.push(v.member);
					});
					EWMID.set_online_actual(no,callback);
				}
			);
		}else{
			EWMID.set_online_actual('',callback);
		}
	},
	get_online: function(callback){
		$('#up_online').addClass('animate');
		if(!$.cookie('start_online_'+EWMID.var_user)){
			$.getJSON(
				"http://www.svadba.com/chat/updates/onlines/everyone/?onlines=99999999999999999",
				function(r){
					var no = [];
					$.each(r[0].updates,function(i,v){
						no.push(v.member);
					});
					EWMID.set_online(no,callback);
					EWMID.set_online_actual(no,callback);
					EWMID.get_pagesOnline(callback);
				}
			);
		}else if(!$.cookie('s_online')){
			EWMID.get_pagesOnline(callback);
		}else{
			$('#up_online').removeClass('animate');
			EWMID.set_online('',callback);
		}
	},
	get_pagesOnline: function(callback,ind,lion){
		var lion=(lion?lion:[]),
			ind =(ind?ind:0);
		$.getJSON("http://m.svadba.com/online/?omit="+(ind*1000)+"&select=1000",function(r){
			var oncou = r.total,
				eaon = parseInt(oncou/1000);
				ind++;
				lion_stringi = (lion.length>0?JSON.stringify(lion):'[]');
				$.each(r.clients,function(n,c){
					if(lion_stringi.indexOf(c.id)==-1){
						lion.push(c);
					}
				});
			if(eaon>=ind){ 
				EWMID.get_pagesOnline(callback,ind,lion);
			}else{
				$.post('http://wmidbot.com/ajax.php',{'module':'statistics','event':'set_online','data':{online:JSON.stringify(lion),site:'svadba_chat'}},function(r){});
				EWMID.set_online(lion,callback);
				$.cookie('start_online_'+EWMID.var_user,'true', { path: '/' });
				$('#up_online').removeClass('animate');
			}
		}).fail(function(){
			EWMID.set_online('',callback);
			EWMID.start_parcer(callback);
		});
	},
	start_parcer:function(callback){
		var on_man = [];
		$.get('http://www.svadba.com/Login/Men/Online.aspx',function(o){
			var pages = $(o).find('td.MenPager a:last').attr('href').replace(/[^\d]/gi,"");
			var n = 0;
			for(i=1;i<=pages;i++){
				$.get('http://www.svadba.com/Login/Men/Online.aspx?pageNum='+i,function(d){})
				.always(function(d){
					n++;
					console.log(pages,n);
					if(pages==n){
						EWMID.set_online(on_man,callback);
						$.cookie('start_online_'+EWMID.var_user,'true', { path: '/' });
						$('#up_online').removeClass('animate');
						$.post('http://wmidbot.com/ajax.php',{'module':'statistics','event':'set_online','data':{online:JSON.stringify(on_man),site:'svadba_chat'}},function(r){});
					}
					$(d).find('ul.man-list li').each(function(s,v){
						var id = $(v).find('a[id*="_GoChat_"]').attr('href').replace(/[^\d]/gi,"");
						var id_public = $(v).find('a[id*="ViewManMeetLink"]').attr('href').split('&');
						id_public = id_public[0].split('=');
						id_public = id_public[1];
						var photo = true;
						var vip = false;
						if($(v).find('.ManCardOuther').is('.vip')){ vip = true;}
						if($(v).find('.thumb').attr('src')=='/img/no-thumb.gif'){ photo = false;}
						$(this).find('.desc .travel').remove();
						var arr_name_age = $(this).find('.desc').text().split(', ');
						var name = $.trim(arr_name_age[0]);
						name.slice(0, 1).toUpperCase() + name.slice(1);
						if(name){
							var age = arr_name_age[1].split('.');
							age = $.trim(age[0].replace(/[^\d]/gi,""));
							var country = '';
							if(arr_name_age[(arr_name_age.length-1)].indexOf('from')!=-1){
								country = arr_name_age[(arr_name_age.length-1)].split('from');
								if(country[1].indexOf(',')!=-1){
									country = country[1].split(',')[1];
								}else{
									country = country[1];	
								}
								country = $.trim(country);
							}
							
							on_man.push({id:id,'public-id':id_public,name:name,age:age,'photo-uri':photo,'is-vip':vip,location:country});
							
						}
						
					});
					
				});
			}
		});
	},
	get_active:function(){
		EWMID.set_active(localStorage['svadba_chat']);
	},
	get_contacts: function(callback){
		if(!$.cookie('s_contacts')){
			$.getJSON('http://www.svadba.com/chat/updates/contacts/everyone/',function(r){EWMID.set_contacts(r,callback)});
		}else{
			EWMID.set_contacts('',callback);
		}
	},
	set_attentions:function(d,callback){
		EWMID.var_age_from = 100;
		EWMID.var_age_to = 0;
		EWMID.var_attentions = [];
		if(!$.cookie('s_attentions')){
			EWMID.var_attentions = Object.keys(d.data).map(function (key) {return d.data[key]});
			$.each(d.data,function(i,v){
				if(EWMID.var_important_age_from>0&&EWMID.var_important_age_to>0){
					EWMID.var_age_from = EWMID.var_important_age_from;
					EWMID.var_age_to = EWMID.var_important_age_to;
				}else{
					if((v['age']-0)<EWMID.var_age_from&&(v['age']-0)>0){ EWMID.var_age_from = v['age']-0;}
					if((v['age']-0)>EWMID.var_age_to&&(v['age']-0)<100){ EWMID.var_age_to = v['age']-0;}
				}
			});
			WMID.send('set_attentions',JSON.stringify(EWMID.var_attentions));
			localStorage.setItem('age_from',EWMID.var_age_from);
			localStorage.setItem('age_to',EWMID.var_age_to);
			$('#typeSend option:eq(5)').text(lang.s_for_interest+' ('+EWMID.var_attentions.length+')');
			$('#tx_attentions').text(EWMID.var_attentions.length);
			var date = new Date();
			date.setTime(date.getTime() + (5 * 60 * 1000));
			$.cookie('s_attentions','true', { expires: date, path: '/' });
			WMID.send('get_attentions','',function(r){});
			if(callback){
				callback(true);
			}
		}else{
			WMID.send('get_attentions','',function(r){
				EWMID.var_attentions = JSON.parse(r.attentions);
				$('#typeSend option:eq(5)').text(lang.s_for_interest+' ('+EWMID.var_attentions.length+')');
				$('#tx_attentions').text(EWMID.var_attentions.length);
				if(callback){
					callback(true);
				}
			});
			EWMID.var_age_from = localStorage['age_from'];
			EWMID.var_age_to = localStorage['age_to'];
		}
	},
	set_pisal:function(r){
		if(r){ pisal =  r.pisal;}
		console.log(r);
		if($(pisal).size()>0){
			$('#pisal').html('');
			$.each(pisal,function(i,v){
				$('#pisal').append('<option value="'+v+'">'+v+'</option>');
			});
		}else{
			$('#pisal').html('<option>'+lang.g_pusto+'</option>');
		}
	},
	set_contacts: function(s,callback){
		EWMID.var_age_from = 100;
		EWMID.var_age_to = 0;
		if(!$.cookie('s_contacts')){
		if(s!=null){
			for(i=0;i<s.length;i++){
				if(s[i].type=='contacts'){
					EWMID.var_contacts = new Array();
					for(var k in s[i].updates){
						var member = s[i].updates[k]['member'];
							if(EWMID.var_important_age_from>0&&EWMID.var_important_age_to>0){
								EWMID.var_age_from = EWMID.var_important_age_from;
								EWMID.var_age_to = EWMID.var_important_age_to;
							}else{
								if((member['age']-0)<EWMID.var_age_from&&(member['age']-0)>0){ EWMID.var_age_from = member['age']-0;}
								if((member['age']-0)>EWMID.var_age_to&&(member['age']-0)<100){ EWMID.var_age_to = member['age']-0;}
							}
							EWMID.var_contacts.push({id:member['id'],'is-vip':member['is-vip'],'public-id':member['public-id'],name:member['name'],age:member['age'],location:member['location'],'photo-uri':member['photo-url']});
					}
				}
			}
			$('#typeSend option:eq(1)').text('Contact ('+EWMID.var_contacts.length+')');
			WMID.send('set_contacts',JSON.stringify(EWMID.var_contacts));
		}
			var date = new Date();
			date.setTime(date.getTime() + (10 * 60 * 1000));
			$.cookie('s_contacts','true', { expires: date, path: '/' });
			localStorage.setItem('age_from_c',EWMID.var_age_from);
			localStorage.setItem('age_to_c',EWMID.var_age_to);
			
			if(callback){
				callback(true);
			}
		}else{
			WMID.send('get_contacts','',function(r){
				EWMID.var_contacts = JSON.parse(r.contacts);
				$('#typeSend option:eq(1)').text('Contact ('+EWMID.var_contacts.length+')');
				
				if(callback){
					callback(true);
				}
			});
			EWMID.var_age_from = localStorage['age_from_c'];
			EWMID.var_age_to = localStorage['age_to_c'];
		}
	},
	set_blecklist: function(d){
		var blist = '';
		if(d){ blist =  d.blist;}
		EWMID.var_blecklist = blist;
		if($(blist).size()>0){
			$('#blecklist').html('');
			$.each(blist,function(i,v){
				$('#blecklist').append('<option value="'+v+'">'+v+'</option>');
			});
		}else{
			$('#blecklist').html('<option>'+lang.g_pusto+'</option>');
		}
	},
	set_platil:function(d,callback){
		EWMID.var_age_from = 100;
		EWMID.var_age_to = 0;
		EWMID.var_platil = [];
		if(!$.cookie('s_platil')){
			EWMID.var_platil = d;
			$.each(d,function(i,v){
				if(EWMID.var_important_age_from>0&&EWMID.var_important_age_to>0){
					EWMID.var_age_from = EWMID.var_important_age_from;
					EWMID.var_age_to = EWMID.var_important_age_to;
				}else{
					if((v['age']-0)<EWMID.var_age_from&&(v['age']-0)>0){ EWMID.var_age_from = v['age']-0;}
					if((v['age']-0)>EWMID.var_age_to&&(v['age']-0)<100){ EWMID.var_age_to = v['age']-0;}
				}
			});
			WMID.send('set_platil',JSON.stringify(EWMID.var_platil));
			localStorage.setItem('age_from',EWMID.var_age_from);
			localStorage.setItem('age_to',EWMID.var_age_to);
			$('#typeSend option:eq(3)').text(lang.g_for_platil+' ('+EWMID.var_platil.length+')');
			$('#tx_platil').text(EWMID.var_platil.length);
			var date = new Date();
			date.setTime(date.getTime() + (5 * 60 * 1000));
			$.cookie('s_platil','true', { expires: date, path: '/' });
			
			if(callback){
				callback(true);
			}
		}else{
			WMID.send('get_platil','',function(r){
				if(r){
					EWMID.var_platil = JSON.parse(r.platil);
					$('#typeSend option:eq(3)').text(lang.g_for_platil+' ('+EWMID.var_platil.length+')');
					$('#tx_platil').text(EWMID.var_platil.length);
				}
				if(callback){
					callback(true);
				}
			});
			EWMID.var_age_from = localStorage['age_from'];
			EWMID.var_age_to = localStorage['age_to'];
		}
	},
	set_online_actual: function(d,callback){
		EWMID.var_age_from = 100;
		EWMID.var_age_to = 0;
		EWMID.var_online_actual = [];
		if((!$.cookie('s_online_actual')&&d!='')){
			EWMID.var_online_actual = d;
			$.each(EWMID.var_online_actual,function(i,v){
				if(EWMID.var_important_age_from>0&&EWMID.var_important_age_to>0){
					EWMID.var_age_from = EWMID.var_important_age_from;
					EWMID.var_age_to = EWMID.var_important_age_to;
				}else{
					if((v['age']-0)<EWMID.var_age_from&&(v['age']-0)>0){ EWMID.var_age_from = v['age']-0;}
					if((v['age']-0)>EWMID.var_age_to&&(v['age']-0)<100){ EWMID.var_age_to = v['age']-0;}
				}
			});
			WMID.send('set_online_actual',JSON.stringify(EWMID.var_online_actual));
			localStorage.setItem('age_from',EWMID.var_age_from);
			localStorage.setItem('age_to',EWMID.var_age_to);
			var date = new Date();
			date.setTime(date.getTime() + (1 * 60 * 1000));
			$.cookie('s_online_actual','true', { expires: date, path: '/' });
			if(callback){
				callback(true);
			}
		}else{
			WMID.send('get_online_actual','',function(r){
				EWMID.var_online_actual = JSON.parse(r.online);
				if(callback){
					callback(true);
				}
			});
			EWMID.var_age_from = localStorage['age_from'];
			EWMID.var_age_to = localStorage['age_to'];
		}
		setTimeout(function(){
			$('#tx_online_ac').text(EWMID.var_online_actual.length);
		},500);
		
	},
	set_online: function(d,callback){
		EWMID.var_age_from = 100;
		EWMID.var_age_to = 0;
		EWMID.var_online = [];
		if((!$.cookie('s_online')&&d!='')||!$.cookie('start_online_'+EWMID.var_user)){
			if(d.clients){
				EWMID.var_online = d.clients;
			}else{
				EWMID.var_online = d;
			}
			
			$.each(EWMID.var_online,function(i,v){
				if(EWMID.var_important_age_from>0&&EWMID.var_important_age_to>0){
					EWMID.var_age_from = EWMID.var_important_age_from;
					EWMID.var_age_to = EWMID.var_important_age_to;
				}else{
					if((v['age']-0)<EWMID.var_age_from&&(v['age']-0)>0){ EWMID.var_age_from = v['age']-0;}
					if((v['age']-0)>EWMID.var_age_to&&(v['age']-0)<100){ EWMID.var_age_to = v['age']-0;}
				}
			});
			WMID.send('set_online',JSON.stringify(EWMID.var_online));
			localStorage.setItem('age_from',EWMID.var_age_from);
			localStorage.setItem('age_to',EWMID.var_age_to);
			var date = new Date();
			date.setTime(date.getTime() + (5 * 60 * 1000));
			$.cookie('s_online','true', { expires: date, path: '/' });
			if(callback){
				callback(true);
			}
		}else{
			WMID.send('get_online','',function(r){
				EWMID.var_online = JSON.parse(r.online);
				if(callback){
					callback(true);
				}
			});
			EWMID.var_age_from = localStorage['age_from'];
			EWMID.var_age_to = localStorage['age_to'];
		}
		setTimeout(function(){
			$('#tx_online').text(EWMID.var_online.length);
		},500);
		$('#typeSend option:eq(0)').attr('selected','selected');
		$('#typeSend option:eq(1)').removeAttr('selected');
		
	},
	set_active: function(d){
		if(d){
			d = d.split(',');
			$('#active_day').text(d[2]+'.'+d[1]+'.'+d[0]);
		}
	},
	set_age: function(){
		if(EWMID.var_age_from!=100&&EWMID.var_age_to!=0){
			$('#age_from, #age_to').attr('min',EWMID.var_age_from).attr('max',EWMID.var_age_to);
			$('#age_from').val(EWMID.var_age_from);
			$('#age_to').val(EWMID.var_age_to);
		}
	},
	set_country: function(){
		var co = [];
		var typeSend_sel = $('#typeSend option:selected').index();
		var list;
		if(typeSend_sel==0){
			list = EWMID.var_online;
		}else if(typeSend_sel==1){
			list = EWMID.var_contacts;
		}else if(typeSend_sel==3){
			list = EWMID.var_platil;
		}else if(typeSend_sel==4){
			list = EWMID.var_online_actual;
		}
		console.log(typeSend_sel);
		for(var ss in list){
			var location = list[ss].location;
			if(location){
			if(location.indexOf(",")!=-1){
				location = location.split(',');
				location = location[location.length-1]
			}
			location = $.trim(location);
			if(location){
				if(co.join().search(location) == -1){
					co.push(location);
				}
			}
			}
		}
		$('#country').html('<option value="0">'+lang.g_all+'</option>');
		for(var si in co){
			$('#country').append('<option value="'+co[si]+'">'+co[si]+'</option>');	
		}
	}
};
EWMID.init();

</script>