<div class="home">
	<div class="header">
		<h1 class="logo"><a href="http://wmidbot.com" lng="g_logo">WMID.com.ua Bot программы для брачных агенств для золушки, дрима, свадьбы, джампа</a></h1>
		<div class="clear10"></div>
	</div>
	<div class="content">
		<div class="leftColumn">
			<ul class="navi">
				<li><a href="http://wmidbot.com/pages/#conte" target="_blank" lng="g_help">Справка</a></li>
				<li><a href="http://wmidbot.com/" target="_blank" lng="g_bayact">Продлить активацию</a></li>
				<li><a href="#" id="blacklist" lng="g_balcklist">Черный список</a></li>
				<li><a href="#" id="writerslist" lng="g_pisallist">Список писателей</a></li>
			</ul>
			<div class="clear10"></div>
			<div class="active">
				<span lng="g_infotags">Переменные:</span><br />
				<b>{Name}</b> <span lng="g_tagname">имя</span><br />
				<b>{Age}</b> <span lng="g_tagage">возраст</span>
			</div>
			<div class="clear10"></div>
			<div class="active">
				<span lng="g_pay_to">Оплачено до:</span><br /><b id="payed"></b>
			</div>
			<div class="clear10"></div>
		</div>
		<div class="rightColumn" id="mainside">
			<b class="title" lng="g_tema">Тема</b> <a href="#" id="addt" lng="g_add">Добавить</a> <a href="#" id="editt" lng="g_edit">Править</a> <a href="#" id="delt" lng="g_delete">Удалить</a>
			<div class="clear5"></div>
			<select class="sel_100" id="subject">
				<option value="0" lng="g_notema">-нет тем-</option>
			</select>
			<div class="clear10"></div>
			<textarea class="text_ms" id="text" placeholder="Add message"></textarea>
			<div class="clear10"></div>
			<b class="title" lng="g_sendfor">Отсылать по</b>
			<div class="clear5"></div>
			<select class="sel_100" id="goal">
				<option value="search" lng="g_for_search">Поиск</option>
				<option value="writers" lng="g_for_writers">По писателям</option>
				<option value="favorites" lng="g_for_favorites">По фаворитам</option>
			</select>
			<div class="clear10"></div>
			<b class="title" lng="g_photos">Фотка</b>
			<input type="file" id="file" />
			<div class="clear10"></div>
			<table style="width:75%" class="table_1">
				<tr>
					<td>
						<b class="title" lng="g_age_from">Взраст от</b>
						<div class="clear5"></div>
						<input type="number" id="age-from" value="20" min="20" max="100" style="width:50px" />
					</td>
					<td class="center"><b>&mdash;</b></td>
					<td>
						<b class="title" lng="g_to">до</b>
						<div class="clear5"></div>
						<input type="number" id="age-to" value="60" min="20" max="100" style="width:50px" />
					</td>
				</tr>
			</table>
			<div class="clear10"></div>
			<a href="#" class="Btn_big" id="start"><b lng="g_start_send">Начать рассылку</b></a>
			<a href="#" class="Btn_big_red" id="stop" style="display:none;"><b lng="g_stop_send">Остановить рассылку</b></a>
			<div class="clear5"></div>
			<img src="" alt="" id="preview">
		</div>
		<div class="rightColumn" style="display:none" id="blackside">
			<div class="clear10"></div>
			<b class="title" lng="g_balcklist">Черный список</b>
			<div class="clear5"></div>
			<select id="black" size="15" style="width:100%" multiple></select>
			<div class="clear10"></div>
			<a href="#" id="addb" class="Btn_normal" title="Add"><b>+</b></a> <a href="#" id="editb" class="Btn_normal"><b lng="g_edit">Править</b></a> <a href="#" id="delb" class="Btn_normal" style="background:#e14747;"><b lng="g_delete">Удалить</b></a>
		</div>
		<div class="rightColumn" style="display:none" id="writersside">
			<div class="clear10"></div>
			<b class="title" lng="g_pisallist">Список писателей</b>
			<div class="clear5"></div>
			<select id="writers" size="15" style="width:100%" multiple></select>
			<div class="clear10"></div>
			<a href="#" id="addw" class="Btn_normal" title="Add"><b>+</b></a> <a href="#" id="editw" class="Btn_normal"><b lng="g_edit">Править</b></a> <a href="#" id="delw" class="Btn_normal" style="background:#e14747;"><b lng="g_delete">Удалить</b></a>
		</div>
		<div class="clear"></div>
	</div>
</div>
<script type="text/javascript">//<![CDATA[
var WLANG = {
	init_html:function(){
		$.each(lang,function(i,v){
			$('[lng="'+i+'"').text(v);
		});
	}
};
WLANG.init_html();

var STAT = {
	var_name: udata.name,
	var_site:'romancecompass_mail',
	var_storage_id: function(){
		return localStorage[STAT.var_site+'storage_id_'+STAT.var_name];
	},
	init: function(){
		STAT.events();
		STAT.get_storage_srv();
	},
	events: function(){
		$('#payed').text(udata.date);
	},
	get_storage_srv: function(){
		if(STAT.var_storage_id()){
			SM({type:"set_storage_id",data:STAT.var_storage_id()});
		}else{
			$.post('http://wmidbot.com/ajax.php',{'module':'statistics','event':'get_storage_invites','data':{girl:STAT.var_name,site:STAT.var_site}},function(d){
				if(d.data!=null){
					localStorage.setItem(STAT.var_site+'storage_id_'+d.data.girl_id, d.data.id);
					storage = JSON.parse(d.data.settings);
					SaveStorage();
					SM({type:"set_storage_id",data:STAT.var_storage_id()});
					STAT.set_settings_controls();
				}
			});
		}
	},
	set_storage_srv: function(obj){
		if(obj){
			$.post('http://wmidbot.com/ajax.php',{'module':'statistics','event':'set_storage_invites','data':{girl:STAT.var_name,json:obj,site:STAT.var_site}},function(d){
				if(d.data!=null){
					localStorage.setItem(STAT.var_site+'storage_id_'+STAT.var_name, d.data);
					SaveStorage();
					SM({type:"set_storage_id",data:STAT.var_storage_id()});
				}
			});
		}
	},
	set_settings_controls: function(call){
			//Заполнение инфы из хранилища
			console.log(storage);
			$.each(storage, function (k, v) {
				if (k == parseInt(k)) $("<option>")
					.val(k)
					.text(v.title)
					.appendTo(subject)
			});
			var resave = false;
			if (storage.goal) goal.val(storage.goal);
			else resave = true;
			if (storage.black) $.each(storage.black, function (k, v) {
				$("<option>")
					.text(v ? v : k)
					.val(k)
					.appendTo(black)
			});
			else storage.black = {};
			if (storage.writers) $.each(storage.writers, function (k, v) {
				$("<option>")
					.text(v ? v : k)
					.val(k)
					.appendTo(writers)
			});
			else storage.writers = {};
			af.change(function () {
				storage.af = parseInt($(this)
					.val());
				if (storage.af >= parseInt(at.val())) at.val(storage.af);
				SaveStorage()
			});
			at.change(function () {
				storage.at = parseInt($(this)
					.val());
				if (storage.at <= parseInt(af.val())) af.val(storage.at);
				SaveStorage()
			});
			goal.change(function () {
				storage.goal = $(this)
					.val();
				SaveStorage()
			});
			text.change(function () {
				if (storage.active in storage) {
					storage[storage.active].text = $(this)
						.val();
					SaveStorage()
				}
			});
			file.change(function (e) {
				e.preventDefault();
				var b = this.files[0]
					, file_url = false
					, rurl = new FileReader()
					, rbin = new FileReader();
				init.file_name = $(this)
					.val()
					.split(/(\\|\/)/g)
					.pop();
				rurl.onload = function (a) {
					file_url = a.target.result;
					rbin.readAsBinaryString(b)
				};
				rbin.onload = function (a) {
					init.file_bin = a.target.result;
					init.file_mime = file_url.split(";")[0].split(":")[1];
					init.file_url = file_url;
					preview.show()
						.prop("src", file_url);
					SaveStorage()
				};
				rurl.readAsDataURL(b)
			});
			if (init.file_url) preview.show()
				.prop("src", init.file_url);
			subject.change(function () {
				var v = $(this)
					.val()
					, save = storage.active != v
					, controls = $("#delt,#editt,#savet,#start");
				if (save) SaveTemplate();
				if (v == "0") {
					controls.prop("disabled", true);
					text.val(text.prop("defaultValue"));
					af.val(af.prop("defaultValue"));
					at.val(at.prop("defaultValue"));
					Status(0)
				} else if (!(v in storage)) $("option:selected", this)
					.remove();
				else {
					af.val(storage[v].af);
					at.val(storage[v].at);
					text.val(storage[v].text);
					Status(storage[v].cnt);
					controls.prop("disabled", false)
				}
				if (save) {
					storage.active = v;
					SaveStorage()
				}
			});
			if (storage.active) subject.val(storage.active);
			else resave = true;
			subject.change();
			if (resave) {}
		if(call){
			return call();
		}
	}
}

var init = $("body")
    .data("init")
    , storage = init.storage
    , black = $("#black")
    , af = $("#age-from")
    , at = $("#age-to")
    , subject = $("#subject")
    , text = $("#text")
    , goal = $("#goal")
    , start = $("#start")
    , stop = $("#stop")
    , preview = $("#preview")
    , writers = $("#writers")
    , mainside = $("#mainside")
    , blackside = $("#blackside")
    , writersside = $("#writersside")
    , file = $("#file")
    , EnableSubject = function () {
		STAT.init();
        var a = $("#subject option:first");
        if (subject.find("option")
            .size() > 1) {
            subject.prop("disabled", false);
            a.text(lang.g_temas)
        } else {
            subject.prop("disabled", true);
            a.text(lang.g_notema)
        }
    }
    , SaveTemplate = function () {
        if (storage.active in storage) $.extend(storage[storage.active], {
            text: text.val()
            , af: af.val()
            , at: at.val()
        })
    }
    , Start = function () {
		STAT.set_storage_srv(storage);
        stop.show();
        start.hide();
        $("#text,#age-from,#age-to,#goal,#subject,#blacklist,#writerslist,#file")
            .prop("disabled", true)
    }
    , Stop = function () {
        start.show();
        stop.hide();
        $("#text,#age-from,#age-to,#goal,#blacklist,#writerslist,#file")
            .prop("disabled", false);
        EnableSubject()
    }
    , SaveStorage = function () {
        SM({
            type: "save"
            , storage: storage
            , file_bin: init.file_bin
            , file_url: init.file_url
            , file_name: init.file_name
            , file_mime: init.file_mime
        })
    }
    , Status = function (a) {
        SM({
            type: "status"
            , sent: a
        })
    };
$("#blacklist")
    .click(function () {
        if (blackside.is(":visible")) {
            blackside.add(writersside)
                .hide();
            mainside.show()
        } else {
            mainside.add(writersside)
                .hide();
            blackside.show()
        }
        return !1
    });
$("#writerslist")
    .click(function () {
        if (writersside.is(":visible")) {
            blackside.add(writersside)
                .hide();
            mainside.show()
        } else {
            mainside.add(blackside)
                .hide();
            writersside.show()
        }
        return !1
    });
$("#addb")
    .click(function () {
        var n = prompt(lang.g_addidman);
        if (n !== null) {
            $.each(n.split(/\D+/), function (k, v) {
                if (black.find("[value=" + v + "]")
                    .size() == 0) {
                    $("<option>")
                        .text(v)
                        .appendTo(black);
                    black.val(v);
                    storage.black[v] = ""
                }
            });
            SaveStorage()
        }
        return !1
    });
$("#editb")
    .click(function () {
        var t = $("#black :selected")
            , text = [];
        if (t.size() > 0) {
            t.each(function () {
                text.push($(this)
                    .val())
            });
            text = prompt(lang.g_editwrite, text.join(", "));
            if (text !== null) {
                t.each(function () {
                        delete storage.black[$(this)
                            .val()]
                    })
                    .remove();
                $.each(text.split(/\D+/), function (k, v) {
                    if (black.find("[value=" + v + "]")
                        .size() == 0) {
                        $("<option>")
                            .text(v)
                            .appendTo(black);
                        black.val(v);
                        storage.black[v] = ""
                    }
                });
                SaveStorage()
            }
        }
        return !1
    });
$("#delb")
    .click(function () {
        var t = $("#black :selected");
        t.each(function () {
                delete storage.black[$(this)
                    .val()]
            })
            .remove();
        SaveStorage();
        return !1
    });
$("#addw")
    .click(function () {
        var n = prompt(lang.g_addidman);
        if (n !== null) {
            $.each(n.split(/\D+/), function (k, v) {
                console.log(v);
                if (writers.find("[value=" + v + "]")
                    .size() == 0) {
                    $("<option>")
                        .text(v)
                        .appendTo(writers);
                    writers.val(v);
                    storage.writers[v] = ""
                }
            });
            SaveStorage()
        }
        return !1
    });
$("#editw")
    .click(function () {
        var t = $("#writers :selected")
            , text = [];
        if (t.size() > 0) {
            t.each(function () {
                text.push($(this)
                    .val())
            });
            text = prompt(lang.g_editwrite, text.join(", "));
            if (text !== null) {
                t.each(function () {
                        delete storage.writers[$(this)
                            .val()]
                    })
                    .remove();
                $.each(text.split(/\D+/), function (k, v) {
                    if (writers.find("[value=" + v + "]")
                        .size() == 0) {
                        $("<option>")
                            .text(v)
                            .appendTo(writers);
                        writers.val(v);
                        storage.writers[v] = ""
                    }
                });
                SaveStorage()
            }
        }
        return !1
    });
$("#delw")
    .click(function () {
        var t = $("#writers :selected");
        t.each(function () {
                delete storage.writers[$(this)
                    .val()]
            })
            .remove();
        SaveStorage();
        return !1
    });
STAT.set_settings_controls();


$("#addt")
    .click(function () {
        var n = prompt(lang.g_addtema);
        if (n) {
            $("<option>")
                .val(storage.last)
                .text(n)
                .appendTo(subject);
            storage[storage.last] = {
                title: n
                , text: text.val()
                , af: af.val()
                , at: at.val()
                , sent: ","
                , cnt: 0
                , offlinepage: 0
            };
            EnableSubject();
            if (init.runned) storage.last++;
            else subject.val(storage.last++)
                .change();
            SaveStorage()
        }
        return false
    });
$("#savet")
    .click(function () {
        SaveTemplate();
        SaveStorage()
    });
$("#editt")
    .click(function () {
        if (!init.runned) {
            var v = subject.val()
                , t = $("#subject option:selected")
                , n;
            if (v > 0) {
                n = prompt(lang.g_addnewtema, t.text());
                if (n && v in storage) {
                    t.text(n);
                    storage[v].title = n;
                    SaveStorage()
                }
            }
        }
        return false
    });
$("#delt")
    .click(function () {
        if (!init.runned) {
            var v = subject.val()
                , t = $("#subject option:selected");
            if (v > 0 && (!(v in storage) || confirm(lang.g_realydelletter+" \"" + t.text() + "\"?"))) {
                var a = t.next()
                    .size() > 0 ? t.next() : t.prev();
                t.remove();
                delete storage[v];
                subject.val(a.val())
                    .change();
                EnableSubject()
            }
        }
        return false
    });
if (init.runned) Start();
start.click(function () {
    if (!(storage.active in storage)) alert(lang.g_selecttemaletter);
    else if (init.limit) alert(lang.g_limitleterisfail);
    else if (storage[storage.active].text == "") alert(lang.g_addtextletter);
    else if (storage[storage.active].title == "") alert(lang.g_addtema+"!");
    else if (storage.goal == "writers" && $.isEmptyObject(storage.writers)) {
        alert(lang.g_addpisalman);
        $("#writerslist")
            .click()
    } else SM({
        type: "start"
        , file_bin: init.file_bin
        , file_url: init.file_url
        , file_name: init.file_name
        , file_mime: init.file_mime
    }, function (r) {
        if (r) {
            init.runned = true;
            Start()
        }
    })
});
stop.click(function () {
    SM({
        type: "stop"
    }, function (r) {
        if (r) {
            init.runned = false;
            Stop()
        }
    })
});
EnableSubject();

//]]></script>